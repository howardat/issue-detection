import pandas as pd

def bar_chart(data_with_tags): 
    df = pd.DataFrame(data_with_tags)
    
    # 1. Ensure date_created is datetime
    df['date_created'] = pd.to_datetime(df['date_created'])
    
    # 2. Determine the full range of months (earliest to latest)
    min_date = df['date_created'].min().replace(day=1)
    max_date = df['date_created'].max().replace(day=1)
    
    # Create a range of every 1st of the month between min and max
    all_months_range = pd.date_range(start=min_date, end=max_date, freq='MS')
    
    # 3. Create the 'month' column BEFORE exploding or grouping
    df['month'] = df['date_created'].dt.strftime('%m-%Y')
    
    # 4. Explode and handle missing tags
    df_exploded = df.explode('tags')
    # Replace NaN tags with a string so Plotly doesn't skip the row
    df_exploded['tags'] = df_exploded['tags'].fillna('No Category')

    # 5. Group and count
    chart_df = df_exploded.groupby(['month', 'tags']).size().reset_index(name='review_count')

    # 6. Re-index to include months with zero reviews
    # Create a helper dataframe with all months
    all_months_df = pd.DataFrame({'month': all_months_range.strftime('%m-%Y')})
    
    # Merge back to ensure 11-2025 (and others) are present
    final_df = pd.merge(all_months_df, chart_df, on='month', how='left')
    
    # Clean up the merged result
    final_df['review_count'] = final_df['review_count'].fillna(0).astype(int)
    final_df['tags'] = final_df['tags'].fillna('No Category')
    
    return final_df

if __name__ == "__main__":
    print("bar_chart.py is running")
    data = [
  {
    "text": "Была здесь недавно, кофе у них конечно вкусный, но соблюдение санитарных норм это ужас! Девушка, которая мыла там полы, пошла готовить кофе! Это что за ужас? Была во многих кофейнях, и у всех есть отдельный тех персонал. Но то, что тот же тех.персонал готовил кофе-вижу впервые. Полный беспредел! Две звёздочки ставлю только из за кофе. А сама ситуация в кофейне оставила очень уж плохое впечатление.",
    "date_created": "2025-12-23T21:59:10.432144+07:00",
    "tags": ["Cleanliness", "Service"]
  },
  {
    "text": "Кофе не понравилась , купили 3 коф за 5000 тг , ожидали вкусные кофе , но вышел какое то невкусный кофе",
    "date_created": "2025-12-11T23:29:48.132138+07:00",
    "tags": ["Food Quality"]
  },
  {
    "text": "1500 тенге за американо с молоком, дороже всех в городе, не советую\nВ меню одна цена, на деле другая.\nКофе тоже не самый вкусный.",
    "date_created": "2025-10-28T12:38:33.053947+07:00",
    "tags": ["Food Quality", "Order Accuracy"]
  },
  {
    "text": "За 1750 тг ожидала вкусное кофе. Не понравилось",
    "date_created": "2025-10-23T19:32:58.170256+07:00",
    "tags": ["Food Quality"]
  },
  {
    "text": "Уютное место с красивым интерьером и вкусными сезонными напитками и особенно понравилась матча. Но есть нюансы: терминалы часто работают через раз, особенно тот, что у окна картой оплатить так и не удалось. С Kaspi QR проблем нет\n\nПеред входом душно, большие окна сильно нагреваются от солнца не хватает вентиляции или хотя бы жалюзи, чтобы не перегревалось (ещё от перегрева страдают планшеты с терминалом, может из-за этого не работают)",
    "date_created": "2025-10-20T12:00:12.174053+07:00",
    "tags": ["Facility", "App/Technical"]
  },
  {
    "text": "Вообще невкусно, не стоит своих денег. Слишком завышены цены за такое качество. Зачем удаляете мои комментарии!?",
    "date_created": "2025-09-23T23:15:02.044302+07:00",
    "tags": ["Food Quality"]
  },
  {
    "text": "Сегодня взяла латте.К сожалению, стакан был грязный снаружи, с подтёками, что выглядит очень неэстетично. Я даже показала это персоналу, но никакой реакции не последовало. Хотелось бы, чтобы заведение уделяло больше внимания подаче — ведь приятно получать напиток не только вкусный, но и в аккуратной, чистой упаковке.",
    "date_created": "2025-08-29T19:36:05.78214+07:00",
    "tags": ["Cleanliness", "Service"]
  },
  {
    "text": "Неприятная ситуация произошла в данном филиале. С женой два раза были тут. Когда сидели, заметили что сотрудница раздает всем какие-то тортики розовые (мб малиновые). Подумали, вау, мелочь а приятно. И когда всем раздала, тупо прошла мимо нас. При чем абсолютно каждому гостю раздала кроме нас (на подносе были еще несколько тортиков). Во второй раз пришли туда. И снова всем раздали кроме нас. Дело не в том, что мы очень сильно хотели этот торт) Мы бы скорее всего все равно сказали что мы такое не любим и пусть лучше другим раздаст. Но просто не приятно что нас по просту проигнорили показательно. Ладно один раз забыли про нас, но два раза уже реально не приятно. К слову заказ мы там уже сделали, сидели не просто так ничего не заказав. Дата и время есть в чеке",
    "date_created": "2025-09-17T21:26:11.03838+07:00",
    "tags": ["Service", "Other"]
  },
  {
    "text": "Была здесь недавно, кофе у них конечно вкусный, но соблюдение санитарных норм это ужас! Девушка, которая мыла там полы, пошла готовить кофе! Это что за ужас? Была во многих кофейнях, и у всех есть отдельный тех персонал. Но то, что тот же тех.персонал готовил кофе-вижу впервые. Полный беспредел! Две звёздочки ставлю только из за кофе. А сама ситуация в кофейне оставила очень уж плохое впечатление.",
    "date_created": "2025-12-23T21:59:10.432144+07:00",
    "tags": ["Cleanliness", "Other"]
  },
  {
    "text": "Кофе не понравилась , купили 3 коф за 5000 тг , ожидали вкусные кофе , но вышел какое то невкусный кофе",
    "date_created": "2025-12-11T23:29:48.132138+07:00",
    "tags": ["Food Quality"]
  },
  {
    "text": "1500 тенге за американо с молоком, дороже всех в городе, не советую\nВ меню одна цена, на деле другая.\nКофе тоже не самый вкусный.",
    "date_created": "2025-10-28T12:38:33.053947+07:00",
    "tags": ["Order Accuracy", "Food Quality"]
  },
  {
    "text": "За 1750 тг ожидала вкусное кофе. Не понравилось",
    "date_created": "2025-10-23T19:32:58.170256+07:00",
    "tags": ["Food Quality"]
  },
  {
    "text": "Уютное место с красивым интерьером и вкусными сезонными напитками и особенно понравилась матча. Но есть нюансы: терминалы часто работают через раз, особенно тот, что у окна картой оплатить так и не удалось. С Kaspi QR проблем нет\n\nПеред входом душно, большие окна сильно нагреваются от солнца не хватает вентиляции или хотя бы жалюзи, чтобы не перегревалось (ещё от перегрева страдают планшеты с терминалом, может из-за этого не работают)",
    "date_created": "2025-10-20T12:00:12.174053+07:00",
    "tags": ["Facility", "App/Technical"]
  },
  {
    "text": "Вообще невкусно, не стоит своих денег. Слишком завышены цены за такое качество. Зачем удаляете мои комментарии!?",
    "date_created": "2025-09-23T23:15:02.044302+07:00",
    "tags": ["Food Quality"]
  },
  {
    "text": "Сегодня взяла латте.К сожалению, стакан был грязный снаружи, с подтёками, что выглядит очень неэстетично. Я даже показала это персоналу, но никакой реакции не последовало. Хотелось бы, чтобы заведение уделяло больше внимания подаче — ведь приятно получать напиток не только вкусный, но и в аккуратной, чистой упаковке.",
    "date_created": "2025-08-29T19:36:05.78214+07:00",
    "tags": ["Service", "Cleanliness"]
  },
  {
    "text": "Неприятная ситуация произошла в данном филиале. С женой два раза были тут. Когда сидели, заметили что сотрудница раздает всем какие-то тортики розовые (мб малиновые). Подумали, вау, мелочь а приятно. И когда всем раздала, тупо прошла мимо нас. При чем абсолютно каждому гостю раздала кроме нас (на подносе были еще несколько тортиков). Во второй раз пришли туда. И снова всем раздали кроме нас. Дело не в том, что мы очень сильно хотели этот торт) Мы бы скорее всего все равно сказали что мы такое не любим и пусть лучше другим раздаст. Но просто не приятно что нас по просту проигнорили показательно. Ладно один раз забыли про нас, но два раза уже реально не приятно. К слову заказ мы там уже сделали, сидели не просто так ничего не заказав. Дата и время есть в чеке",
    "date_created": "2025-09-17T21:26:11.03838+07:00",
    "tags": ["Service", "Other"]
  }
]

    print(bar_chart(data))